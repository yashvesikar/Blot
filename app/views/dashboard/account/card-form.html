<style>

    #card {
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 12px 10px;
      height: 16px;
    }
    </style>
  
  
  <input type="hidden" name="stripeToken" class="stripeToken" value="">

<p id="error" style="display: none;"></p>
<label for="card">
  Your card
</label>
<!-- Payment Request Button container for Apple Pay/Google Pay -->
<div id="payment-request-button" style="margin-bottom: 1em;"></div>
<div id="card" class="field"></div>



<script src="https://js.stripe.com/v3/"></script>
<script type="text/javascript">
var stripe = Stripe('{{stripe_key}}');  // Use your actual publishable key
  var elements = stripe.elements();

  var style = {
    base: {
      fontSize: '16px',
      color: "#000",
      iconColor: "#9ba0ac",
      '::placeholder': {
        color: "#9ba0ac"
      },
    }
  };


  // Create a single card input
  var card = elements.create('card', {style: style});

  card.mount('#card');

  // Add Payment Request Button for Apple Pay/Google Pay
  // Only show if subscription amount is available (payment-method route)
  var subscriptionAmount = {{#subscription_amount_cents}}{{subscription_amount_cents}}{{/subscription_amount_cents}}{{^subscription_amount_cents}}0{{/subscription_amount_cents}};
  var subscriptionCurrency = '{{#subscription_currency}}{{subscription_currency}}{{/subscription_currency}}{{^subscription_currency}}usd{{/subscription_currency}}';

  if (subscriptionAmount > 0) {
    var paymentRequest = stripe.paymentRequest({
      country: 'US',
      currency: subscriptionCurrency,
      total: {
        label: 'Blot subscription',
        amount: subscriptionAmount,
      },
      requestPayerEmail: false, // User is already logged in
    });

    var paymentRequestButton = elements.create('paymentRequestButton', {
      paymentRequest: paymentRequest,
      style: {
        paymentRequestButton: {
          theme: 'dark',
          height: '48px',
        },
      },
    });

    // Check if Payment Request is available (Apple Pay, Google Pay, etc.)
    paymentRequest.canMakePayment().then(function(result) {
      if (result) {
        // Show the Payment Request Button
        paymentRequestButton.mount('#payment-request-button');
      } else {
        // Hide the container if Payment Request is not available
        document.getElementById('payment-request-button').style.display = 'none';
      }
    });

    // Handle payment method from Payment Request Button
    paymentRequest.on('paymentmethod', function(ev) {
      // The payment method is already created by the Payment Request API
      // We can use ev.paymentMethod.id directly (starts with 'pm_')
      // This is better for recurring payments than tokens
      if (!ev.paymentMethod || !ev.paymentMethod.id) {
        ev.complete('fail');
        renderError('Unable to process payment method');
        return;
      }

      ev.complete('success');
      // Submit the form with the Payment Method ID
      stripeTokenHandler({ id: ev.paymentMethod.id });
    });
  } else {
    // Hide the container if subscription amount is not available
    document.getElementById('payment-request-button').style.display = 'none';
  }

  function setFocusColor(elementId) {
    document.getElementById(elementId).style.borderColor = 'var(--accent-color)';
    document.querySelector('label[for="' + elementId + '"]').style.color = 'var(--accent-color)';
  }

  function resetFocusColor(elementId) {
    document.getElementById(elementId).style.borderColor = 'var(--border-color)';
    document.querySelector('label[for="' + elementId + '"]').style.color = '';
  }

  card.on('focus', function () {
      // reset the error message and enable the submit button
      document.getElementById('error').style.display = 'none';
      document.querySelector('button[type="submit"]').classList.remove('working');
      setFocusColor(card._parent.id);
    });
    card.on('blur', function () {
      resetFocusColor(card._parent.id);
    });

  function renderError(message){
    var errorElement = document.getElementById('error');
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        document.querySelector('button[type="submit"]').classList.remove('working');

  }

  var form = document.getElementById('payment-form');

  form.addEventListener('submit', function(event) {

    // update the class on the submit button to show that it is working
    document.querySelector('button[type="submit"]').classList.add('working');

    event.preventDefault();

    stripe.createToken(card).then(function(result) {

      if (result.error) {
        // Inform the user if there was an error
        renderError(result.error.message);
      } else {
        // Assume function stripeTokenHandler exists to handle the received token
        stripeTokenHandler(result.token);
      }
    });
  });


  function stripeTokenHandler(tokenOrPaymentMethod) {
    // Accept either a token object (from card input) or Payment Method ID (from Apple Pay/Google Pay)
    // Both have an 'id' property - tokens start with 'tok_' and Payment Methods start with 'pm_'
    var form = document.getElementById('payment-form');
    var hiddenInput = document.querySelector('input.stripeToken');
    hiddenInput.setAttribute('value', tokenOrPaymentMethod.id);
    form.submit();
  }

</script>